library(rstan)
library(bayesplot)
options(mc.cores = parallel::detectCores())

N = 200
subjectids = c(1,  1,  1,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  2,  2,  2,  3,
               3,  3,  3,  3,  3,  3,  3,  4,  4,  4,  4,  4,  4,  4,  4,  5,  5,
               5,  5,  5,  5,  5,  5,  6,  6,  6,  6,  6,  6,  6,  6,  7,  7,  7,
               7,  7,  7,  7,  7,  8,  8,  8,  8,  8,  8,  8,  8,  9,  9,  9,  9,
               9,  9,  9,  9, 10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11,
               11, 11, 11, 12, 12, 12, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13, 13,
               13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 15, 15, 15, 15, 15, 15, 15,
               15, 16, 16, 16, 16, 16, 16, 16, 16, 17, 17, 17, 17, 17, 17, 17, 17,
               18, 18, 18, 18, 18, 18, 18, 18, 19, 19, 19, 19, 19, 19, 19, 19, 20,
               20, 20, 20, 20, 20, 20, 20, 21, 21, 21, 21, 21, 21, 21, 21, 22, 22,
               22, 22, 22, 22, 22, 22, 23, 23, 23, 23, 23, 23, 23, 23, 24, 24, 24,
               24, 24, 24, 24, 24, 25, 25, 25, 25, 25, 25, 25, 25)

n_subjects = length(unique(subjectids))

times = c(0.5       ,  2.14285714,  3.78571429,  5.42857143,  7.07142857,
          8.71428571, 10.35714286, 12.        ,  0.5       ,  2.14285714,
          3.78571429,  5.42857143,  7.07142857,  8.71428571, 10.35714286,
          12.        ,  0.5       ,  2.14285714,  3.78571429,  5.42857143,
          7.07142857,  8.71428571, 10.35714286, 12.        ,  0.5       ,
          2.14285714,  3.78571429,  5.42857143,  7.07142857,  8.71428571,
          10.35714286, 12.        ,  0.5       ,  2.14285714,  3.78571429,
          5.42857143,  7.07142857,  8.71428571, 10.35714286, 12.        ,
          0.5       ,  2.14285714,  3.78571429,  5.42857143,  7.07142857,
          8.71428571, 10.35714286, 12.        ,  0.5       ,  2.14285714,
          3.78571429,  5.42857143,  7.07142857,  8.71428571, 10.35714286,
          12.        ,  0.5       ,  2.14285714,  3.78571429,  5.42857143,
          7.07142857,  8.71428571, 10.35714286, 12.        ,  0.5       ,
          2.14285714,  3.78571429,  5.42857143,  7.07142857,  8.71428571,
          10.35714286, 12.        ,  0.5       ,  2.14285714,  3.78571429,
          5.42857143,  7.07142857,  8.71428571, 10.35714286, 12.        ,
          0.5       ,  2.14285714,  3.78571429,  5.42857143,  7.07142857,
          8.71428571, 10.35714286, 12.        ,  0.5       ,  2.14285714,
          3.78571429,  5.42857143,  7.07142857,  8.71428571, 10.35714286,
          12.        ,  0.5       ,  2.14285714,  3.78571429,  5.42857143,
          7.07142857,  8.71428571, 10.35714286, 12.        ,  0.5       ,
          2.14285714,  3.78571429,  5.42857143,  7.07142857,  8.71428571,
          10.35714286, 12.        ,  0.5       ,  2.14285714,  3.78571429,
          5.42857143,  7.07142857,  8.71428571, 10.35714286, 12.        ,
          0.5       ,  2.14285714,  3.78571429,  5.42857143,  7.07142857,
          8.71428571, 10.35714286, 12.        ,  0.5       ,  2.14285714,
          3.78571429,  5.42857143,  7.07142857,  8.71428571, 10.35714286,
          12.        ,  0.5       ,  2.14285714,  3.78571429,  5.42857143,
          7.07142857,  8.71428571, 10.35714286, 12.        ,  0.5       ,
          2.14285714,  3.78571429,  5.42857143,  7.07142857,  8.71428571,
          10.35714286, 12.        ,  0.5       ,  2.14285714,  3.78571429,
          5.42857143,  7.07142857,  8.71428571, 10.35714286, 12.        ,
          0.5       ,  2.14285714,  3.78571429,  5.42857143,  7.07142857,
          8.71428571, 10.35714286, 12.        ,  0.5       ,  2.14285714,
          3.78571429,  5.42857143,  7.07142857,  8.71428571, 10.35714286,
          12.        ,  0.5       ,  2.14285714,  3.78571429,  5.42857143,
          7.07142857,  8.71428571, 10.35714286, 12.        ,  0.5       ,
          2.14285714,  3.78571429,  5.42857143,  7.07142857,  8.71428571,
          10.35714286, 12.        ,  0.5       ,  2.14285714,  3.78571429,
          5.42857143,  7.07142857,  8.71428571, 10.35714286, 12.        )


yobs = c(0.07639669, 0.2166292 , 0.1980823 , 0.15113448, 0.10861279,
         0.0762601 , 0.05303418, 0.03673352, 0.05033592, 0.16546965,
         0.15475041, 0.11735141, 0.08222312, 0.0555468 , 0.03684438,
         0.02420596, 0.06401094, 0.21486261, 0.19572057, 0.14515069,
         0.09994881, 0.06662654, 0.04373848, 0.02849873, 0.04281389,
         0.19739867, 0.16608301, 0.11863014, 0.08145478, 0.05532847,
         0.03746767, 0.02535055, 0.06770117, 0.18756391, 0.16660052,
         0.12613777, 0.09128728, 0.06511134, 0.04621515, 0.03274857,
         0.06886647, 0.19161289, 0.16901196, 0.12558577, 0.08853705,
         0.06126314, 0.04209695, 0.02885063, 0.0414135 , 0.15798383,
         0.15479455, 0.12343918, 0.09150727, 0.06574671, 0.04656054,
         0.0327465 , 0.04560305, 0.18756723, 0.17927208, 0.13800058,
         0.09815156, 0.06737889, 0.04546276, 0.03040827, 0.01953911,
         0.17499712, 0.17366721, 0.13544915, 0.09682502, 0.06653429,
         0.04483054, 0.0298998 , 0.0488037 , 0.1842498 , 0.16911292,
         0.12813019, 0.09134603, 0.06365215, 0.04395386, 0.03023992,
         0.04926928, 0.14297614, 0.12876198, 0.09756101, 0.07010802,
         0.04944117, 0.0346228 , 0.02418123, 0.04938299, 0.19345292,
         0.17791303, 0.13641651, 0.09916249, 0.07077928, 0.05019079,
         0.03550633, 0.05465323, 0.202157  , 0.16803796, 0.11429723,
         0.07279898, 0.04519046, 0.02775298, 0.01696596, 0.05553742,
         0.20073498, 0.18640408, 0.14234354, 0.10186991, 0.07106107,
         0.04903879, 0.03368441, 0.02573613, 0.14330326, 0.13564392,
         0.10619197, 0.07875656, 0.05736536, 0.04152152, 0.02998629,
         0.04719973, 0.17484058, 0.1638895 , 0.12493954, 0.08852499,
         0.06078718, 0.04114022, 0.02765131, 0.066434  , 0.21677339,
         0.18292011, 0.12866088, 0.08562889, 0.05588307, 0.03620463,
         0.02339058, 0.04585273, 0.16013561, 0.16268238, 0.13506191,
         0.10422076, 0.07788754, 0.05733409, 0.04189338, 0.06584313,
         0.16306932, 0.13827977, 0.10272378, 0.07398706, 0.05286547,
         0.03769383, 0.0268611 , 0.07099982, 0.25422272, 0.20336159,
         0.1409226 , 0.09465818, 0.06310578, 0.04199259, 0.02793029,
         0.04865831, 0.18140643, 0.16302184, 0.1210348 , 0.08462033,
         0.05785573, 0.03921106, 0.0264814 , 0.05704332, 0.18502618,
         0.17003725, 0.13064191, 0.09498735, 0.06770898, 0.04790442,
         0.03379503, 0.03449722, 0.2035247 , 0.17612689, 0.12738651,
         0.08796547, 0.05991294, 0.04063308, 0.02752075, 0.08584539,
         0.22020093, 0.17983277, 0.12579392, 0.08437132, 0.0558618 ,
         0.03683364, 0.02425476, 0.07338024, 0.21957591, 0.1753775 ,
         0.11723816, 0.07431582, 0.0462469 , 0.02858683, 0.01762659)

stan_data = list(N = N, subjectids = subjectids, n_subjects = n_subjects, yobs = yobs, times = times)

model = stan_model(file = '~/Documents/PhD Code/PKBayes/weak_model.stan')

fit = sampling(model, stan_data,  control = list(max_treedepth = 12))


np = nuts_params(fit)
mcmc_parcoord(fit, pars = c('log_CL','log_ke','log_ka','alpha'), np=np)

mcmc_parcoord(fit, pars = c('delay_mu','delay_kappa'), np=np)

mcmc_parcoord(fit, pars = c('s_ka','s_ke','s_CL'), np=np)
